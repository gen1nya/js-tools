<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator & Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
        }

        .tool-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .tool-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #5a67d8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-icon {
            font-size: 1.8rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: white;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .qr-display {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
            border: 2px dashed #cbd5e0;
        }

        .qr-display canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .qr-display.empty {
            color: #a0aec0;
            font-style: italic;
        }

        .camera-container {
            position: relative;
            margin-top: 20px;
            text-align: center;
        }

        #camera {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border-radius: 15px;
            border: 3px solid #667eea;
            background: #f7fafc;
            object-fit: cover;
        }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            word-break: break-all;
        }

        .result-box.error {
            background: #fed7d7;
            border-color: #fc8181;
        }

        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 480px) {
            .settings-row {
                grid-template-columns: 1fr;
            }
        }

        .download-btn {
            margin-top: 15px;
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        .status {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üì± QR Tools</h1>
        <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —á—Ç–µ–Ω–∏–µ QR –∫–æ–¥–æ–≤</p>
        <div id="library-status" style="display: none;"></div>
    </div>

    <div class="tools-grid">
        <!-- QR Generator -->
        <div class="tool-card">
            <h2 class="tool-title">
                <span class="tool-icon">üîß</span>
                –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR –∫–æ–¥–æ–≤
            </h2>

            <div class="input-group">
                <label for="qr-text">–¢–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫–∞:</label>
                <textarea id="qr-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, —Å—Å—ã–ª–∫—É –∏–ª–∏ –ª—é–±—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é..."></textarea>
            </div>

            <div class="settings-row">
                <div class="input-group">
                    <label for="qr-size">–†–∞–∑–º–µ—Ä:</label>
                    <select id="qr-size">
                        <option value="200">–ú–∞–ª–µ–Ω—å–∫–∏–π (200px)</option>
                        <option value="300" selected>–°—Ä–µ–¥–Ω–∏–π (300px)</option>
                        <option value="400">–ë–æ–ª—å—à–æ–π (400px)</option>
                        <option value="500">–û—á–µ–Ω—å –±–æ–ª—å—à–æ–π (500px)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="qr-color">–¶–≤–µ—Ç:</label>
                    <select id="qr-color">
                        <option value="#000000">–ß—ë—Ä–Ω—ã–π</option>
                        <option value="#333333">–¢—ë–º–Ω–æ-—Å–µ—Ä—ã–π</option>
                        <option value="#667eea">–°–∏–Ω–∏–π</option>
                        <option value="#48bb78">–ó–µ–ª—ë–Ω—ã–π</option>
                        <option value="#ed8936">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
                        <option value="#e53e3e">–ö—Ä–∞—Å–Ω—ã–π</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="generateQR()">–°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥</button>

            <div id="qr-result" class="qr-display empty">
                QR –∫–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            </div>

            <button id="download-btn" class="btn download-btn" onclick="downloadQR()" style="display: none;">
                –°–∫–∞—á–∞—Ç—å QR –∫–æ–¥
            </button>
        </div>

        <!-- QR Reader -->
        <div class="tool-card">
            <h2 class="tool-title">
                <span class="tool-icon">üì∑</span>
                –°–∫–∞–Ω–µ—Ä QR –∫–æ–¥–æ–≤
            </h2>

            <div style="background: #e6fffa; border: 1px solid #81e6d9; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 0.9rem;">
                <strong>üí° –°–æ–≤–µ—Ç:</strong> –î–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã –∫–∞–º–µ—Ä—ã –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (Safari, Chrome)
            </div>

            <button class="btn btn-secondary" onclick="startCamera()">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button class="btn" onclick="stopCamera()" style="display: none;" id="stop-btn">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É</button>

            <div class="camera-container">
                <div id="qr-reader" style="width: 100%; max-width: 350px; margin: 0 auto;"></div>
                <div id="qr-file-result" style="display: none;"></div>
                <div class="status" id="camera-status">–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</div>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label for="file-input">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å QR –∫–æ–¥–æ–º:</label>
                <input type="file" id="file-input" accept="image/*" onchange="readQRFromFile(event)">
                <small style="color: #666; font-size: 0.8rem;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, WebP –∏ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</small>
            </div>

            <div id="scan-result" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
    let html5QrCode = null;
    let isScanning = false;
    let lastQRCanvas = null;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ —Å—Ä–µ–¥—ã
    window.addEventListener('load', function() {
        setTimeout(checkLibraries, 1000);
        checkBrowserEnvironment();
    });

    function checkBrowserEnvironment() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isInApp = navigator.userAgent.includes('Twitter') ||
            navigator.userAgent.includes('FBAN') ||
            navigator.userAgent.includes('FBAV') ||
            navigator.userAgent.includes('Instagram') ||
            navigator.userAgent.includes('LinkedIn') ||
            window.navigator.standalone === false;

        const isEmbedded = !window.matchMedia('(display-mode: browser)').matches &&
            !window.matchMedia('(display-mode: standalone)').matches;

        if (isIOS && (isInApp || isEmbedded)) {
            showEnvironmentWarning();
        }
    }

    function showEnvironmentWarning() {
        const warningDiv = document.createElement('div');
        warningDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center;">
                    <strong>üì± –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è iOS</strong><br>
                    –°–∫–∞–Ω–µ—Ä QR –∫–æ–¥–æ–≤ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ<br>
                    <button onclick="openInSafari()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 15px; border-radius: 5px; margin-top: 8px; cursor: pointer;">
                        –û—Ç–∫—Ä—ã—Ç—å –≤ Safari
                    </button>
                </div>
            `;
        document.getElementById('library-status').appendChild(warningDiv);
        document.getElementById('library-status').style.display = 'block';
    }

    function openInSafari() {
        // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Safari
        const currentUrl = window.location.href;
        window.open(currentUrl, '_blank');
    }

    function checkLibraries() {
        const status = [];
        if (typeof qrcode === 'undefined') {
            status.push('QR Generator library –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        }
        if (typeof Html5Qrcode === 'undefined') {
            status.push('QR Reader library –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        }

        if (status.length > 0) {
            console.warn('–ü—Ä–æ–±–ª–µ–º—ã —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏:', status.join(', '));
            document.getElementById('library-status').style.display = 'block';
            document.getElementById('library-status').innerHTML =
                '<div style="background: #fed7d7; color: #c53030; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center;">' +
                '<strong>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π:</strong><br>' + status.join('<br>') +
                '<br><small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</small></div>';
        }
    }

    // QR Generator
    function generateQR() {
        const text = document.getElementById('qr-text').value.trim();
        const size = parseInt(document.getElementById('qr-size').value);
        const color = document.getElementById('qr-color').value;

        if (!text) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞');
            return;
        }

        if (typeof qrcode === 'undefined') {
            alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }

        try {
            const resultDiv = document.getElementById('qr-result');
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('empty');

            // –°–æ–∑–¥–∞–µ–º QR –∫–æ–¥ —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π qrcode-generator
            const qr = qrcode(0, 'M'); // type number, error correction level
            qr.addData(text);
            qr.make();

            // –°–æ–∑–¥–∞–µ–º canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const moduleCount = qr.getModuleCount();
            const cellSize = Math.floor(size / moduleCount);
            const margin = Math.floor(cellSize * 2);

            canvas.width = cellSize * moduleCount + margin * 2;
            canvas.height = cellSize * moduleCount + margin * 2;

            // –ó–∞–ª–∏–≤–∞–µ–º —Ñ–æ–Ω –±–µ–ª—ã–º
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –†–∏—Å—É–µ–º QR –∫–æ–¥
            ctx.fillStyle = color;
            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col)) {
                        ctx.fillRect(
                            col * cellSize + margin,
                            row * cellSize + margin,
                            cellSize,
                            cellSize
                        );
                    }
                }
            }

            resultDiv.appendChild(canvas);
            lastQRCanvas = canvas;
            document.getElementById('download-btn').style.display = 'block';

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ QR –∫–æ–¥–∞: ' + error.message);
        }
    }

    function downloadQR() {
        if (!lastQRCanvas) return;

        const link = document.createElement('a');
        link.download = 'qr-code.png';
        link.href = lastQRCanvas.toDataURL();
        link.click();
    }

    // QR Reader
    async function startCamera() {
        if (typeof Html5Qrcode === 'undefined') {
            alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è QR –∫–æ–¥–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }

        if (isScanning) {
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –∫–∞–º–µ—Ä—ã
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('camera-status').textContent =
                '–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.';
            return;
        }

        try {
            document.getElementById('camera-status').textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...';

            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–∫–∞–Ω–µ—Ä–∞
            html5QrCode = new Html5Qrcode("qr-reader");

            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
            const cameras = await Html5Qrcode.getCameras().catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä:', error);
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏.');
            });

            if (cameras && cameras.length) {
                // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                let cameraId = cameras[0].id;
                if (cameras.length > 1) {
                    const backCamera = cameras.find(camera =>
                        camera.label && camera.label.toLowerCase().includes('back'));
                    if (backCamera) {
                        cameraId = backCamera.id;
                    }
                }

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    disableFlip: false,
                    videoConstraints: {
                        facingMode: "environment"
                    }
                };

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                await html5QrCode.start(
                    cameraId,
                    config,
                    (decodedText, decodedResult) => {
                        // –£—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω QR –∫–æ–¥
                        displayScanResult(decodedText);
                        stopCamera();
                    },
                    (errorMessage) => {
                        // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–±—ã—á–Ω—ã–µ, –∫–æ–≥–¥–∞ QR –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω)
                        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    }
                );

                isScanning = true;
                document.querySelector('.btn-secondary').style.display = 'none';
                document.getElementById('stop-btn').style.display = 'inline-block';
                document.getElementById('camera-status').textContent = '–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–æ–¥.';

            } else {
                document.getElementById('camera-status').textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
            let errorMessage = '–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ';

            if (error.name === 'NotAllowedError') {
                errorMessage += '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
            } else if (error.name === 'NotSupportedError') {
                errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.';
            } else if (error.message.includes('–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä')) {
                errorMessage += error.message + ' –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Safari –∏–ª–∏ Chrome.';
            } else {
                errorMessage += error.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (Safari/Chrome).';
            }

            document.getElementById('camera-status').textContent = errorMessage;
        }
    }

    async function stopCamera() {
        if (html5QrCode && isScanning) {
            try {
                await html5QrCode.stop();
                await html5QrCode.clear();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã:', error);
            }
        }

        html5QrCode = null;
        isScanning = false;

        document.querySelector('.btn-secondary').style.display = 'inline-block';
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('camera-status').textContent = '–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
    }

    function readQRFromFile(event) {
        if (typeof Html5Qrcode === 'undefined') {
            alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è QR –∫–æ–¥–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }

        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            displayScanResult(null, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const statusDiv = document.getElementById('camera-status');
        statusDiv.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';

        // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                showImagePreview(e.target.result);

                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                tryMultipleScanMethods(file, img, e.target.result);
            };
            img.onerror = function() {
                displayScanResult(null, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                statusDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
            };
            img.src = e.target.result;
        };
        reader.onerror = function() {
            displayScanResult(null, '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            statusDiv.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞';
        };
        reader.readAsDataURL(file);
    }

    function showImagePreview(imageSrc) {
        const resultDiv = document.getElementById('scan-result');
        resultDiv.style.display = 'block';
        resultDiv.className = 'result-box';
        resultDiv.innerHTML = `
                <strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:</strong><br>
                <img src="${imageSrc}" style="max-width: 200px; max-height: 200px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><br>
                <div style="color: #666; font-size: 0.9rem;">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º QR –∫–æ–¥...</div>
            `;
    }

    async function tryMultipleScanMethods(file, img, imageSrc) {
        const statusDiv = document.getElementById('camera-status');
        let qrFound = false;

        // –ú–µ—Ç–æ–¥ 1: Html5Qrcode –Ω–∞–ø—Ä—è–º—É—é —Å —Ñ–∞–π–ª–æ–º
        try {
            statusDiv.textContent = '–ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            const html5QrCodeScanner = new Html5Qrcode("qr-file-result");
            const result = await html5QrCodeScanner.scanFile(file, true);
            displayScanResult(result);
            statusDiv.textContent = 'QR –∫–æ–¥ –Ω–∞–π–¥–µ–Ω!';
            qrFound = true;
            return;
        } catch (error) {
            console.log('–ú–µ—Ç–æ–¥ 1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', error);
        }

        // –ú–µ—Ç–æ–¥ 2: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (!qrFound) {
            try {
                statusDiv.textContent = '–ú–µ—Ç–æ–¥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
                const processedImages = await preprocessImage(img);

                for (let i = 0; i < processedImages.length; i++) {
                    try {
                        const canvas = processedImages[i];
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        const file = new File([blob], 'processed.png', { type: 'image/png' });

                        const html5QrCodeScanner = new Html5Qrcode("qr-file-result");
                        const result = await html5QrCodeScanner.scanFile(file, true);
                        displayScanResult(result);
                        statusDiv.textContent = 'QR –∫–æ–¥ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏!';
                        qrFound = true;
                        return;
                    } catch (error) {
                        console.log(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${i + 1} –Ω–µ –¥–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:`, error);
                    }
                }
            } catch (error) {
                console.log('–ú–µ—Ç–æ–¥ 2 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', error);
            }
        }

        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
        if (!qrFound) {
            displayFailureResult(imageSrc);
            statusDiv.textContent = 'QR –∫–æ–¥ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω';
        }
    }

    async function preprocessImage(img) {
        const canvases = [];

        // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

        // 1. –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º
        const canvas1 = document.createElement('canvas');
        const ctx1 = canvas1.getContext('2d');
        canvas1.width = img.width;
        canvas1.height = img.height;
        ctx1.drawImage(img, 0, 0);

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å
        const imageData1 = ctx1.getImageData(0, 0, canvas1.width, canvas1.height);
        enhanceContrast(imageData1);
        ctx1.putImageData(imageData1, 0, 0);
        canvases.push(canvas1);

        // 2. –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞–ª–µ–Ω—å–∫–æ–µ)
        if (img.width < 500 || img.height < 500) {
            const canvas2 = document.createElement('canvas');
            const ctx2 = canvas2.getContext('2d');
            const scale = Math.max(500 / img.width, 500 / img.height);
            canvas2.width = img.width * scale;
            canvas2.height = img.height * scale;

            ctx2.imageSmoothingEnabled = false; // –ß–µ—Ç–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
            ctx2.drawImage(img, 0, 0, canvas2.width, canvas2.height);

            const imageData2 = ctx2.getImageData(0, 0, canvas2.width, canvas2.height);
            enhanceContrast(imageData2);
            ctx2.putImageData(imageData2, 0, 0);
            canvases.push(canvas2);
        }

        // 3. –ß–µ—Ä–Ω–æ-–±–µ–ª–∞—è –≤–µ—Ä—Å–∏—è
        const canvas3 = document.createElement('canvas');
        const ctx3 = canvas3.getContext('2d');
        canvas3.width = img.width;
        canvas3.height = img.height;
        ctx3.drawImage(img, 0, 0);

        const imageData3 = ctx3.getImageData(0, 0, canvas3.width, canvas3.height);
        convertToGrayscale(imageData3);
        enhanceContrast(imageData3);
        ctx3.putImageData(imageData3, 0, 0);
        canvases.push(canvas3);

        return canvases;
    }

    function enhanceContrast(imageData) {
        const data = imageData.data;
        const contrast = 1.5; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏
        const factor = (259 * (contrast * 255 + 255)) / (255 * (259 - contrast * 255));

        for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));     // R
            data[i + 1] = Math.max(0, Math.min(255, factor * (data[i + 1] - 128) + 128)); // G
            data[i + 2] = Math.max(0, Math.min(255, factor * (data[i + 2] - 128) + 128)); // B
        }
    }

    function convertToGrayscale(imageData) {
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            data[i] = gray;     // R
            data[i + 1] = gray; // G
            data[i + 2] = gray; // B
        }
    }

    function displayFailureResult(imageSrc) {
        const resultDiv = document.getElementById('scan-result');
        resultDiv.style.display = 'block';
        resultDiv.className = 'result-box error';
        resultDiv.innerHTML = `
                <strong>QR –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</strong><br>
                <img src="${imageSrc}" style="max-width: 200px; max-height: 200px; margin: 10px 0; border-radius: 8px;"><br>
                <div style="font-size: 0.9rem; margin-top: 10px;">
                    <strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong><br>
                    ‚Ä¢ QR –∫–æ–¥ —Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–∏–π –∏–ª–∏ –Ω–µ—á–µ—Ç–∫–∏–π<br>
                    ‚Ä¢ –ü–ª–æ—Ö–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –Ω–∞ —Ñ–æ—Ç–æ<br>
                    ‚Ä¢ QR –∫–æ–¥ —á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω<br>
                    ‚Ä¢ –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è<br><br>
                    <strong>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</strong><br>
                    ‚Ä¢ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ QR –∫–æ–¥–∞ –∫—Ä—É–ø–Ω–µ–µ –∏ —á–µ—Ç—á–µ<br>
                    ‚Ä¢ –£–ª—É—á—à–∏—Ç—å –æ—Å–≤–µ—â–µ–Ω–∏–µ<br>
                    ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—É –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                </div>
            `;
    }

    function displayScanResult(data, error = null) {
        const resultDiv = document.getElementById('scan-result');
        resultDiv.style.display = 'block';

        if (error) {
            resultDiv.className = 'result-box error';
            resultDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${error}`;
        } else {
            resultDiv.className = 'result-box';
            const isUrl = data.startsWith('http://') || data.startsWith('https://');

            if (isUrl) {
                resultDiv.innerHTML = `
                        <strong>–ù–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞:</strong><br>
                        <a href="${data}" target="_blank" style="color: #667eea; text-decoration: none; word-break: break-all;">${data}</a>
                        <br><br>
                        <button class="btn" onclick="copyToClipboard(\`${data.replace(/`/g, '\\`')}\`)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    `;
            } else {
                const escapedData = data.replace(/`/g, '\\`').replace(/\\/g, '\\\\');
                resultDiv.innerHTML = `
                        <strong>–¢–µ–∫—Å—Ç QR –∫–æ–¥–∞:</strong><br>
                        <div style="word-break: break-all; margin: 10px 0;">${data}</div>
                        <button class="btn" onclick="copyToClipboard(\`${escapedData}\`)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    `;
            }
        }
    }

    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess();
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                fallbackCopyTextToClipboard(text);
            });
        } else {
            fallbackCopyTextToClipboard(text);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess();
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏');
        }

        document.body.removeChild(textArea);
    }

    function showCopySuccess() {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        button.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';

        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }, 2000);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ textarea
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('qr-text').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                generateQR();
            }
        });
    });
</script>
</body>
</html>