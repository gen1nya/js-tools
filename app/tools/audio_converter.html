<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vanilla Audio Converter (FFmpeg.wasm)</title>
  <meta name="color-scheme" content="dark light" />
  <!-- FFmpeg wrapper (0.11.6 exists on unpkg/jsDelivr) -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --text:#e6e8eb; --muted:#9aa3af; --accent:#7c9cff; --ok:#22c55e; --err:#ef4444; --border:#2a2f3a; }
    *, *::before, *::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; background:var(--bg); color:var(--text); display:flex; padding:24px}
    .wrap{margin:auto; width:clamp(320px, 92vw, 960px); padding:20px; background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 6px; font-size:20px}
    .sub{color:var(--muted); margin-bottom:18px}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#131722; color:#cbd5e1}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    @media (max-width: 720px){ .col-6,.col-4{grid-column:span 12} }
    label{display:block; font-weight:600; margin:4px 0 6px}
    input[type="file"], select, input[type="number"], input[type="text"]{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0c0f14; color:var(--text); min-height:40px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    button{cursor:pointer; border:1px solid var(--border); background:var(--accent); color:white; padding:10px 14px; border-radius:10px; font-weight:600}
    button.secondary{background:#262b36}
    button:disabled{opacity:.6; cursor:default}
    progress{width:100%; height:14px}
    .status{padding:10px 12px; border-radius:10px; background:#0c0f14; border:1px dashed var(--border); color:var(--muted); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .status strong{color:var(--text)}
    .log{height:160px; overflow:auto; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0c0f14}
    .out{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    a.button{background:#242938; color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; border:1px solid var(--border)}
    .err{color:var(--err)} .ok{color:var(--ok)} .hint{color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Vanilla Audio Converter</h1>
    <div class="sub">FFmpeg.wasm грузится на старте (single‑thread ядро, без SharedArrayBuffer). Если CDN блокируется, можно указать локальный путь.</div>

    <div class="row" style="margin-bottom:12px; align-items:center; justify-content:space-between">
      <span class="badge" id="ffmpegState">FFmpeg: загружается…</span>
      <span class="hint">Локальный путь (опц.): <code id="baseEcho">(CDN)</code></span>
    </div>

    <div class="grid" style="margin-bottom:12px;">
      <div class="col-12">
        <label for="file">Файл</label>
        <input id="file" type="file" accept="audio/*" />
      </div>
      <div class="col-6">
        <label for="format">Формат</label>
        <select id="format">
          <option value="mp3">MP3 (libmp3lame)</option>
          <option value="wav">WAV (pcm_s16le)</option>
          <option value="flac">FLAC</option>
          <option value="ogg">OGG (libvorbis)</option>
          <option value="m4a">M4A/AAC (aac)</option>
        </select>
      </div>
      <div class="col-6">
        <label for="bitrate">Битрейт (MP3/AAC), kbps</label>
        <input id="bitrate" type="number" placeholder="например, 192" />
      </div>
      <div class="col-6">
        <label for="samplerate">Sample Rate, Hz</label>
        <input id="samplerate" type="number" placeholder="например, 44100" />
      </div>
      <div class="col-6">
        <label for="channels">Каналов</label>
        <select id="channels">
          <option value="">Как в исходнике</option>
          <option value="1">1 (mono)</option>
          <option value="2">2 (stereo)</option>
        </select>
      </div>
      <div class="col-6">
        <label for="ss">Начало (опц.)</label>
        <input id="ss" type="text" placeholder="00:00:03.5" />
      </div>
      <div class="col-6">
        <label for="to">Конец (опц.)</label>
        <input id="to" type="text" placeholder="00:00:15.0" />
      </div>
    </div>

    <div class="row" style="margin-bottom:12px;">
      <button id="convertBtn" disabled>Конвертировать</button>
      <button id="clearBtn" class="secondary">Очистить</button>
    </div>

    <div class="row" style="margin-bottom:10px;">
      <progress id="prog" value="0" max="1" aria-label="Прогресс загрузки/кодека"></progress>
    </div>

    <div class="status" id="status">Статус: <strong id="statusText">ждём файл…</strong></div>

    <h3 style="margin:16px 0 8px;">Логи</h3>
    <div class="log" id="log"></div>

    <h3 style="margin:16px 0 8px;">Результат</h3>
    <div class="out" id="out"></div>

    <div class="hint" style="margin-top:12px">Открывайте по <code>http(s)://</code> (не <code>file://</code>). Для CSP добавьте источники: unpkg/jsDelivr.</div>
  </div>

<script>
/**
 * === Версии и пути ===
 * Рабочие пары версий:
 *  - @ffmpeg/ffmpeg@0.11.6  (обёртка)
 *  - @ffmpeg/core@0.11.1    (ядро: ffmpeg-core.js/.wasm/.worker.js)
 Эти версии действительно существуют на unpkg/jsDelivr и совместимы между собой.
 */
const CDN_BASES = [
  'https://unpkg.com/@ffmpeg/core@0.11.1/dist',
  'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.1/dist',
  'https://fastly.jsdelivr.net/npm/@ffmpeg/core@0.11.1/dist'
];
let FFMPEG_CORE_BASE = '';// если нужно — выставьте, напр.: '/ffmpeg'

document.querySelector('#baseEcho').textContent = FFMPEG_CORE_BASE || '(CDN)';
const $ = (s)=>document.querySelector(s);
const logEl = $('#log');
const stateEl = $('#ffmpegState');
const statusText = $('#statusText');
const btn = $('#convertBtn');
const prog = $('#prog');

function logLine(line, type='') {
  const ts = new Date().toLocaleTimeString();
  logEl.textContent += `[${ts}] ${line}\n`;
  logEl.scrollTop = logEl.scrollHeight;
  if (type==='err') console.error(line); else console.log(line);
}
function setState(text, ok=false, err=false){
  stateEl.textContent = text;
  stateEl.style.borderColor = err ? 'var(--err)' : ok ? 'var(--ok)' : 'var(--border)';
}

async function loadFFmpeg() {
  const { createFFmpeg } = FFmpeg;
  const bases = FFMPEG_CORE_BASE ? [FFMPEG_CORE_BASE] : CDN_BASES;
  const errors = [];
  for (const base of bases) {
    try {
      logLine(`Пробую ядро: ${base}`);
      const ff = createFFmpeg({
        log: true,
        corePath: `${base}/ffmpeg-core.js`,
        progress: ({ ratio }) => { if (ratio>0 && ratio<1) prog.value = ratio; }
      });
      await ff.load();
      logLine(`FFmpeg загружен из: ${base}`);
      setState('FFmpeg загружен', true);
      return ff;
    } catch (e) {
      errors.push(`${base}: ${e && e.message ? e.message : e}`);
      logLine(`Не удалось: ${base} — ${e && e.message ? e.message : e}`, 'err');
    }
  }
  throw new Error('Все источники ядра недоступны: ' + errors.join(' | '));
}

let ffmpeg;
(async () => {
  try { ffmpeg = await loadFFmpeg(); btn.disabled = false; }
  catch (e) { setState('Ошибка загрузки FFmpeg', false, true); statusText.textContent = 'Ошибка загрузки FFmpeg'; logLine('Критическая ошибка: '+e.message, 'err'); }
})();

$('#clearBtn').addEventListener('click', () => { $('#file').value=''; $('#out').innerHTML=''; logEl.textContent=''; statusText.textContent='ждём файл…'; prog.value=0; });

function buildArgs({ inputName, outputName, format, bitrate, samplerate, channels, ss, to }) {
  const args = ['-y'];
  if (ss) args.push('-ss', ss);
  args.push('-i', inputName);
  if (to) args.push('-to', to);
  if (channels) args.push('-ac', String(channels));
  if (samplerate) args.push('-ar', String(samplerate));
  if (bitrate && (format==='mp3' || format==='m4a')) args.push('-b:a', `${bitrate}k`);
  switch (format) {
    case 'mp3': args.push('-c:a','libmp3lame'); break;
    case 'wav': args.push('-c:a','pcm_s16le'); break;
    case 'flac': args.push('-c:a','flac'); break;
    case 'ogg': args.push('-c:a','libvorbis'); break;
    case 'm4a': args.push('-c:a','aac'); break;
  }
  args.push(outputName);
  return args;
}

function mimeFor(ext){
  switch(ext){
    case 'mp3': return 'audio/mpeg';
    case 'wav': return 'audio/wav';
    case 'flac': return 'audio/flac';
    case 'ogg': return 'audio/ogg';
    case 'm4a': return 'audio/mp4';
    default: return 'application/octet-stream';
  }
}

$('#convertBtn').addEventListener('click', async () => {
  const file = $('#file').files[0];
  if (!file) { alert('Выберите файл'); return; }
  if (!ffmpeg) { alert('FFmpeg не готов'); return; }

  const format = $('#format').value;
  const bitrate = $('#bitrate').value;
  const samplerate = $('#samplerate').value;
  const channels = $('#channels').value;
  const ss = $('#ss').value.trim();
  const to = $('#to').value.trim();

  statusText.textContent = 'Конвертация…';
  prog.value = 0;

  const inputName = `input_${Date.now()}`;
  const outputName = `output_${Date.now()}.${format}`;

  try {
    const data = await FFmpeg.fetchFile(file);
    ffmpeg.FS('writeFile', inputName, data);

    const args = buildArgs({ inputName, outputName, format, bitrate, samplerate, channels, ss, to });
    logLine('Команда: ffmpeg ' + args.join(' '));

    await ffmpeg.run(...args);

    const out = ffmpeg.FS('readFile', outputName);
    const blob = new Blob([out], { type: mimeFor(format) });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url; a.download = (file.name.replace(/\.[^.]+$/, '')||'audio') + '.' + format; a.textContent = 'Скачать ' + a.download; a.className = 'button';

    $('#out').innerHTML = ''; $('#out').appendChild(a);
    statusText.innerHTML = '<span class="ok">Готово</span>';
  } catch (e) {
    statusText.innerHTML = '<span class="err">Ошибка: ' + e.message + '</span>';
    logLine('Ошибка конвертации: ' + e.message, 'err');
  } finally {
    try { ffmpeg.FS('unlink', inputName); } catch {}
    try { ffmpeg.FS('unlink', outputName); } catch {}
  }
});
</script>
</body>
</html>
